<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Todos los art√≠culos ‚Äî Pulque Vivo</title>
  <meta name="description" content="Listado completo de art√≠culos sobre pulque, naturaleza y bioconstrucci√≥n." />
  <style>
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial,'Apple Color Emoji','Segoe UI Emoji';line-height:1.55;color:#0f172a;background:#f6f8fb}
    :root{
      --brand:#059669; --ink:#0f172a; --muted:#475569; --card:#ffffff;
      --shadow:0 20px 50px -12px rgba(0,0,0,.15); --radius:20px;
    }
    html.dark{color-scheme:dark}
    html.dark body{color:#e5e7eb;background:#0b0f17}
    a{color:inherit;text-decoration:none}

    .container{max-width:1180px;margin-inline:auto;padding:0 20px}
    .row{display:flex;align-items:center;justify-content:space-between}
    .stack-2{display:grid;gap:.5rem}
    .stack-3{display:grid;gap:.75rem}
    .stack-4{display:grid;gap:1rem}

    .nav{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.65);backdrop-filter:saturate(180%) blur(12px);border-bottom:1px solid rgba(0,0,0,.06)}
    html.dark .nav{background:rgba(11,15,23,.55);border-color:rgba(255,255,255,.08)}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700}
    .brand-badge{display:inline-grid;place-items:center;width:36px;height:36px;border-radius:12px;background:var(--brand);color:#fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border:0;border-radius:16px;padding:.6rem 1rem;font-weight:600;cursor:pointer}
    .btn-ghost{background:#fff;border:1px solid rgba(15,23,42,.08);color:#0f172a}
    html.dark .btn-ghost{background:#192131;border-color:rgba(255,255,255,.12);color:#fff}

    .title{font-size:clamp(24px,4.5vw,40px);margin:18px 0}
    .muted{color:#64748b}

    .posts-grid{display:grid;grid-template-columns:1fr;gap:1rem}
    @media (min-width:640px){.posts-grid{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:980px){.posts-grid{grid-template-columns:repeat(3,1fr)}}

    .card{border-radius:var(--radius);background:rgba(255,255,255,.75);border:1px solid rgba(15,23,42,.06);box-shadow:var(--shadow);overflow:hidden}
    html.dark .card{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.1)}
    .post-cover{height:160px;background:linear-gradient(135deg,rgba(16,185,129,.15),rgba(250,204,21,.15));}
    html.dark .post-cover{background:linear-gradient(135deg,rgba(16,185,129,.18),rgba(250,204,21,.12));}

    .pager{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;justify-content:center;margin:22px 0 30px}
    .page-link{padding:.5rem .8rem;border-radius:10px;border:1px solid rgba(15,23,42,.12);background:#fff;color:#0f172a}
    .page-link:hover{border-color:#0f172a}
    .page-link[aria-current="page"]{background:var(--brand);border-color:var(--brand);color:#fff}
    html.dark .page-link{background:#192131;border-color:rgba(255,255,255,.12);color:#e5e7eb}
    html.dark .page-link:hover{border-color:#fff}
  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="container row" style="padding:10px 0">
      <a class="brand" href="index.html">
        <span class="brand-badge" aria-hidden>üç∂</span>
        <span>Pulque Vivo</span>
      </a>
      <div class="stack-2" style="grid-auto-flow:column;gap:1rem;align-items:center">
        <a class="btn btn-ghost" href="index.html">Inicio</a>
        <button id="themeBtn" class="btn btn-ghost" type="button">Modo oscuro</button>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="container">
    <h1 class="title">Todos los art√≠culos</h1>
    <p class="muted" id="status">Cargando‚Ä¶</p>
  </header>

  <!-- LISTADO -->
  <main class="container">
    <section class="posts-grid" id="postsGrid"></section>
    <nav class="pager" id="pager" aria-label="Paginaci√≥n"></nav>
  </main>

  <footer class="container" style="padding:24px 0;color:#64748b">
    ¬© Pulque Vivo
  </footer>

  <script>
    // ===== Tema oscuro persistente =====
    const htmlEl = document.documentElement;
    const themeBtn = document.getElementById('themeBtn');
    const saved = localStorage.getItem('pulque.theme');
    if(saved === 'dark'){ htmlEl.classList.add('dark'); themeBtn.textContent = 'Modo claro'; }
    themeBtn.addEventListener('click', ()=>{
      htmlEl.classList.toggle('dark');
      const dark = htmlEl.classList.contains('dark');
      localStorage.setItem('pulque.theme', dark ? 'dark' : 'light');
      themeBtn.textContent = dark ? 'Modo claro' : 'Modo oscuro';
    });

    // ===== Util =====
    const qs = new URLSearchParams(location.search);
    function getInt(name, def){ const n = parseInt(qs.get(name),10); return Number.isFinite(n) && n>0 ? n : def; }
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

    const PAGE_SIZE = getInt('per', 9);

    async function loadAll(){
      const status = document.getElementById('status');
      let posts = [];
      try{
        const res = await fetch('./posts.json?v=' + Date.now(), { cache: 'no-store' });
        if(res.ok){ posts = await res.json(); }
      }catch(_){}
      if(!posts.length){
        status.textContent = (location.protocol === 'file:') 
          ? 'Abre con Live Server (fetch bloqueado en file://).'
          : 'No se encontr√≥ posts.json en la ra√≠z.';
        return;
      }
      status.textContent = `${posts.length} art√≠culos publicados`;
      render(posts);
    }

    function render(items){
      const page = getInt('page', 1);
      const total = items.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      const current = Math.min(page, totalPages);

      const start = (current - 1) * PAGE_SIZE;
      const slice = items.slice(start, start + PAGE_SIZE);

      const grid = document.getElementById('postsGrid');
      grid.innerHTML = '';
      slice.forEach(p=>{
        const el = document.createElement('article');
        el.className = 'card';
        el.innerHTML = `
          <a href="${p.url||'#'}" style="display:block">
            <div class="post-cover" ${p.cover ? `style="background-image:url('${p.cover}');background-size:cover;background-position:center"` : ''}></div>
            <div style="padding:14px">
              <div style="font-size:12px;color:var(--brand)">${escapeHtml(p.tag||'')}</div>
              <h3 style="margin:.25rem 0 .35rem;font-size:1.05rem">${escapeHtml(p.title||'')}</h3>
              <p class="muted" style="margin:0">${escapeHtml(p.excerpt||'')}</p>
            </div>
          </a>`;
        grid.appendChild(el);
      });

      renderPager(totalPages, current);
    }

    function renderPager(totalPages, current){
      const pager = document.getElementById('pager');
      pager.innerHTML = '';
      if(totalPages <= 1) return;

      const makeLink = (n, label = n, isCurrent = false)=>{
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = `?page=${n}&per=${PAGE_SIZE}`;
        a.textContent = label;
        if(isCurrent) a.setAttribute('aria-current','page');
        return a;
      };

      // Prev
      if(current > 1) pager.appendChild(makeLink(current-1,'¬´ Anterior'));

      // N√∫meros (ventana compacta)
      const windowSize = 5;
      let start = Math.max(1, current - Math.floor(windowSize/2));
      let end = Math.min(totalPages, start + windowSize - 1);
      if(end - start + 1 < windowSize) start = Math.max(1, end - windowSize + 1);

      if(start > 1){
        pager.appendChild(makeLink(1,'1'));
        if(start > 2){ const span = document.createElement('span'); span.className='muted'; span.textContent='‚Ä¶'; pager.appendChild(span); }
      }
      for(let n=start; n<=end; n++){
        pager.appendChild(makeLink(n, String(n), n===current));
      }
      if(end < totalPages){
        if(end < totalPages-1){ const span = document.createElement('span'); span.className='muted'; span.textContent='‚Ä¶'; pager.appendChild(span); }
        pager.appendChild(makeLink(totalPages,String(totalPages)));
      }

      // Next
      if(current < totalPages) pager.appendChild(makeLink(current+1,'Siguiente ¬ª'));
    }

    loadAll();
  </script>
</body>
</html>
