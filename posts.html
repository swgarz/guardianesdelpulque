<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Todos los art√≠culos ‚Äî Pulque Vivo</title>
  <meta name="description" content="Listado completo de art√≠culos con paginaci√≥n." />
  <style>
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial;line-height:1.5;color:#0f172a;background:#f6f8fb}
    :root{--brand:#059669;--ink:#0f172a;--muted:#475569;--card:#ffffff;--stroke:#e5e7eb}
    a{color:inherit;text-decoration:none}
    .container{max-width:1180px;margin-inline:auto;padding:0 24px}
    .nav{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.7);backdrop-filter:saturate(180%) blur(12px);border-bottom:1px solid rgba(0,0,0,.06)}
    .nav .row{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700}
    .brand-badge{display:inline-grid;place-items:center;width:36px;height:36px;border-radius:12px;background:var(--brand);color:#fff}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:0;border-radius:16px;padding:.6rem 1rem;font-weight:600;cursor:pointer}
    .btn-brand{background:var(--brand);color:#fff}
    .grid{display:grid;grid-template-columns:1fr;gap:1rem}
    @media (min-width:860px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{border-radius:22px;background:#fff;border:1px solid rgba(15,23,42,.06);box-shadow:0 20px 50px -12px rgba(0,0,0,.12);overflow:hidden}
    .post-cover{height:160px;background:linear-gradient(135deg,rgba(16,185,129,.15),rgba(250,204,21,.15))}
    .pill{display:inline-flex;gap:.5rem;align-items:center;padding:.25rem .6rem;border-radius:12px;background:rgba(16,185,129,.12);color:#065f46;font-weight:600;font-size:12px}
    .top{display:flex;align-items:end;justify-content:space-between;margin:20px 0 12px}
    .muted{color:#64748b}
    /* Paginaci√≥n */
    .pagination{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;justify-content:center;margin:28px 0 40px}
    .page-btn{display:inline-flex;align-items:center;justify-content:center;min-width:36px;height:36px;padding:0 .75rem;border:1px solid var(--stroke);border-radius:10px;background:#fff;color:#0f172a;font-weight:600}
    .page-btn[aria-current="page"]{background:var(--brand);color:#fff;border-color:transparent}
    .page-btn:disabled{opacity:.5;cursor:not-allowed}
    footer{border-top:1px solid rgba(15,23,42,.08);padding:24px 0;margin-top:40px;color:#64748b}
  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="container row">
      <a class="brand" href="index.html">
        <span class="brand-badge">üç∂</span><span>Pulque Vivo</span>
      </a>
      <div>
        <a class="btn btn-brand" href="index.html">Inicio</a>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="container" style="padding:28px 0 8px">
    <div class="top">
      <h1 style="margin:0">Todos los art√≠culos</h1>
      <small id="totalCount" class="muted"></small>
    </div>
    <p class="muted" id="status"></p>
  </header>

  <!-- LISTADO -->
  <main class="container">
    <div id="postsGrid" class="grid"></div>
    <nav id="pagination" class="pagination" aria-label="Paginaci√≥n"></nav>
  </main>

  <footer>
    <div class="container" style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;align-items:center;gap:.5rem">
        <span class="brand-badge" style="width:28px;height:28px">üç∂</span><span>Pulque Vivo</span>
      </div>
      <small class="muted">¬© 2025</small>
    </div>
  </footer>

  <script>
    const PAGE_SIZE = 9;

    // Utilidad: lee params
    const params = new URLSearchParams(location.search);
    const debug  = params.get('debug') === '1';

    // Carga posts.json de la misma carpeta (ra√≠z del repo)
    async function fetchPosts() {
      const url = 'posts.json?v=' + Date.now(); // cache-bust
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('No se pudo cargar ' + url);
      const data = await res.json();
      return Array.isArray(data) ? data : (Array.isArray(data.entries) ? data.entries : []);
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    }

    function renderPosts(items){
      const grid = document.getElementById('postsGrid');
      grid.innerHTML = '';
      items.forEach(p=>{
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="post-cover" ${p.cover ? `style="background-image:url('${p.cover}');background-size:cover;background-position:center"` : ''}></div>
          <div style="padding:16px">
            <div class="pill">${escapeHtml(p.tag || '')}</div>
            <h3 style="margin:.4rem 0 0.25rem">${escapeHtml(p.title || '')}</h3>
            <p class="muted" style="margin:0 0 .5rem">${escapeHtml(p.excerpt || '')}</p>
            <a class="btn" style="border:1px solid rgba(15,23,42,.1)" href="${p.url || '#'}" target="_blank" rel="noopener">Leer ‚Üí</a>
          </div>`;
        grid.appendChild(card);
      });
    }

    function renderPagination(total, page){
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      const nav = document.getElementById('pagination');
      nav.innerHTML = '';

      const makeBtn = (label, targetPage, disabled=false, current=false) => {
        const a = document.createElement('a');
        a.className = 'page-btn';
        a.textContent = label;
        if (current) a.setAttribute('aria-current','page');
        if (disabled) a.setAttribute('disabled','');
        else a.href = `?page=${targetPage}${debug ? '&debug=1' : ''}`;
        return a;
      };

      // Prev
      nav.appendChild(makeBtn('¬´', Math.max(1, page-1), page===1));
      // N√∫meros (ventana de 1..totalPages, con compactaci√≥n simple)
      const windowSize = 7;
      let start = Math.max(1, page - 3);
      let end   = Math.min(totalPages, start + windowSize - 1);
      if (end - start + 1 < windowSize) start = Math.max(1, end - windowSize + 1);

      if (start > 1) {
        nav.appendChild(makeBtn('1', 1));
        if (start > 2) {
          const dots = document.createElement('span');
          dots.className = 'muted';
          dots.textContent = '‚Ä¶';
          nav.appendChild(dots);
        }
      }
      for (let i = start; i <= end; i++) {
        nav.appendChild(makeBtn(String(i), i, false, i===page));
      }
      if (end < totalPages) {
        if (end < totalPages - 1) {
          const dots = document.createElement('span');
          dots.className = 'muted';
          dots.textContent = '‚Ä¶';
          nav.appendChild(dots);
        }
        nav.appendChild(makeBtn(String(totalPages), totalPages));
      }
      // Next
      nav.appendChild(makeBtn('¬ª', Math.min(totalPages, page+1), page===totalPages));
    }

    async function init(){
      const status  = document.getElementById('status');
      const counter = document.getElementById('totalCount');
      let posts = [];
      try{
        posts = await fetchPosts();
        if (debug && status) status.textContent = 'Cargado posts.json (ok)';
      }catch(e){
        if (status) status.textContent = 'No se pudo cargar posts.json. Aseg√∫rate de que est√© junto a posts.html.';
        console.error(e);
      }

      // Si no hay posts, salimos con mensaje
      if (!posts.length) {
        document.getElementById('postsGrid').innerHTML = '<p class="muted">A√∫n no hay art√≠culos.</p>';
        counter.textContent = '';
        return;
      }

      // P√°gina actual
      const page = Math.max(1, parseInt(new URLSearchParams(location.search).get('page') || '1', 10));
      const total = posts.length;
      counter.textContent = `${total} art√≠culos ‚Ä¢ P√°gina ${page}`;

      // Slice para la p√°gina
      const start = (page - 1) * PAGE_SIZE;
      const pageItems = posts.slice(start, start + PAGE_SIZE);

      renderPosts(pageItems);
      renderPagination(total, page);
    }

    init();
  </script>
</body>
</html>
